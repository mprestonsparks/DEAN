# DEAN Deployment Scripts

This directory contains deployment scripts for the DEAN orchestration system.

## Scripts Overview

### deploy_local.sh
Deploys DEAN orchestration locally using Docker Compose.

**Features:**
- Checks prerequisites (Docker, ports)
- Builds Docker image
- Creates local docker-compose configuration
- Starts all services
- Performs health checks

**Usage:**
```bash
./deploy_local.sh
```

**Requirements:**
- Docker and Docker Compose installed
- Ports 8082, 5432, 6379, 8200 available
- At least 4GB free RAM

### deploy_production.sh
Deploys DEAN orchestration to production Kubernetes cluster.

**Features:**
- Multiple deployment strategies (blue-green, canary, rolling)
- Automated image building and pushing
- Helm chart management
- Smoke testing
- Post-deployment tasks

**Usage:**
```bash
# Default deployment
./deploy_production.sh

# With custom settings
DEPLOY_ENV=staging DEPLOY_STRATEGY=canary ./deploy_production.sh
```

**Environment Variables:**
- `DEPLOY_ENV`: Target environment (default: production)
- `DEPLOY_REGION`: Deployment region (default: us-east-1)
- `DEPLOY_NAMESPACE`: Kubernetes namespace (default: dean-system)
- `DEPLOY_STRATEGY`: Deployment strategy (default: blue-green)
- `DOCKER_REGISTRY`: Docker registry URL

### health_check.sh
Comprehensive health check for DEAN system.

**Features:**
- Checks all core services
- Database connectivity tests
- Performance metrics
- Detailed status reporting

**Usage:**
```bash
# Check local deployment
./health_check.sh

# Check remote deployment
ORCHESTRATION_URL=https://dean.example.com ./health_check.sh
```

**Environment Variables:**
- `ORCHESTRATION_URL`: Orchestration server URL
- `INDEXAGENT_URL`: IndexAgent API URL
- `AIRFLOW_URL`: Airflow API URL
- `EVOLUTION_URL`: Evolution API URL
- `HEALTH_CHECK_TIMEOUT`: Request timeout in seconds

### rollback.sh
Safe rollback mechanism for production deployments.

**Features:**
- List available revisions
- Rollback to specific revision
- Dry-run mode
- Automatic backup before rollback
- Progress monitoring

**Usage:**
```bash
# List revisions
./rollback.sh --list

# Rollback to previous revision
./rollback.sh

# Rollback to specific revision
./rollback.sh --revision 5

# Dry run
./rollback.sh --revision 5 --dry-run
```

**Options:**
- `-r, --revision <number>`: Target revision
- `-l, --list`: List available revisions
- `-d, --dry-run`: Show what would happen
- `-f, --force`: Skip confirmation
- `-n, --namespace <name>`: Kubernetes namespace

## Deployment Workflows

### Local Development
1. Clone the repository
2. Copy `.env.example` to `.env` and configure
3. Run `./deploy_local.sh`
4. Access dashboard at http://localhost:8082

### Production Deployment

#### Blue-Green Strategy
Best for critical production deployments with zero downtime.

1. Deploy to inactive environment (green)
2. Run smoke tests
3. Switch traffic to green
4. Remove old environment (blue)

#### Canary Strategy
Best for gradual rollouts with risk mitigation.

1. Deploy new version to small subset
2. Gradually increase traffic percentage
3. Monitor metrics at each stage
4. Complete rollout or rollback based on health

#### Rolling Strategy
Best for simple updates with minimal resources.

1. Update pods one by one
2. Wait for health checks
3. Continue until all pods updated

### Rollback Procedure
1. Identify issue requiring rollback
2. Run `./rollback.sh --list` to see options
3. Choose target revision
4. Execute rollback with monitoring
5. Verify system health

## Configuration

### Docker Configuration
Located in `docker-compose.local.yml` (generated by deploy_local.sh):
- Service definitions
- Network configuration
- Volume mounts
- Environment variables

### Kubernetes Configuration
Helm charts in `helm/dean-orchestration/`:
- `Chart.yaml`: Chart metadata
- `values.yaml`: Default values
- `templates/`: Kubernetes manifests

### Environment Variables
Key variables used across scripts:
- Service URLs and ports
- Database credentials
- Resource limits
- Feature flags

## Security Considerations

### Local Deployment
- Uses default credentials (change in production!)
- No TLS/SSL (development only)
- Open ports on localhost only

### Production Deployment
- Requires proper RBAC setup
- Uses secrets for credentials
- TLS/SSL required
- Network policies recommended
- Pod security policies enforced

## Troubleshooting

### Common Issues

#### Port Already in Use
```bash
# Find process using port
lsof -i :8082

# Kill process
kill -9 <PID>
```

#### Docker Build Fails
```bash
# Clean Docker cache
docker system prune -a

# Rebuild with no cache
docker build --no-cache .
```

#### Kubernetes Deployment Stuck
```bash
# Check pod status
kubectl get pods -n dean-system

# View pod logs
kubectl logs -n dean-system <pod-name>

# Describe pod for events
kubectl describe pod -n dean-system <pod-name>
```

#### Health Check Failures
1. Check service logs
2. Verify network connectivity
3. Check resource availability
4. Ensure environment variables are set
5. Verify database migrations

### Debug Mode
Enable debug logging:
```bash
# Local
DEAN_LOG_LEVEL=DEBUG ./deploy_local.sh

# Production
helm upgrade dean-orchestration ./helm/dean-orchestration \
  --set env.DEAN_LOG_LEVEL=DEBUG
```

## Best Practices

1. **Always run health checks** after deployment
2. **Test in staging** before production
3. **Monitor metrics** during and after deployment
4. **Keep backups** before major changes
5. **Document changes** in deployment log
6. **Use version tags** for production images
7. **Implement gradual rollouts** for safety
8. **Automate where possible** but maintain manual controls

## Maintenance

### Regular Tasks
- Update dependencies monthly
- Review and rotate credentials
- Clean up old Docker images
- Prune unused Kubernetes resources
- Update documentation

### Monitoring
Set up alerts for:
- Service health status
- Resource utilization
- Error rates
- Response times
- Deployment failures

## Contributing

When adding new deployment scripts:
1. Follow existing naming conventions
2. Include comprehensive error handling
3. Add help/usage information
4. Update this README
5. Test in multiple environments
6. Consider backward compatibility